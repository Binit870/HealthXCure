// src/components/FitnessPlanner.jsx
import React, { useState, useEffect } from "react";
import { motion } from "framer-motion";
import { FaDumbbell, FaRunning, FaWalking, FaBiking, FaSwimmer, FaRedo } from "react-icons/fa";
import API from "../../utils/Api"; // Assuming API client is configured
import { useAuth } from "../../context/AuthContext"; // Assuming Auth Context is available
import FitnessResults from "./FitnessResults";
import FitnessHistory from "./FitnessHistory";

const weeklyGoals = [
Â  "3 sessions/week (Beginner)",
Â  "4 sessions/week (Intermediate)",
Â  "5 sessions/week (Advanced)",
];

const FitnessPlanner = () => {
Â  const { user } = useAuth();
Â  const userId = user?._id;

Â  const [height, setHeight] = useState("");
Â  const [weight, setWeight] = useState("");
Â  const [targetWeight, setTargetWeight] = useState("");
Â  const [weeklyGoal, setWeeklyGoal] = useState(weeklyGoals[0]);
Â  const [preferredExercises, setPreferredExercises] = useState(""); // ğŸ’¡ NEW STATE for user preference
Â  
Â  const [bmi, setBmi] = useState(null);
Â  const [plan, setPlan] = useState(null); // Now stores the full structured plan object
Â  const [tip, setTip] = useState("");
Â  const [history, setHistory] = useState([]);

Â  // Tips are now generated by the AI on the backend, so we simplify this local array
Â  // const tips = [ ... ]; 

Â  const fetchHistory = async () => {
Â  Â  try {
Â  Â  Â  if (!userId) return;
Â  Â  Â  const res = await API.get(`/fitness/history/${userId}`);
Â  Â  Â  if (res.data.success) {
Â  Â  Â  Â  // If the plan in history is stored as a JSON string, you might need to parse it here:
        const historyData = res.data.history.map(entry => ({
            ...entry,
            plan: typeof entry.plan === 'string' ? JSON.parse(entry.plan) : entry.plan 
        }));
Â  Â  Â  Â  setHistory(historyData);
Â  Â  Â  } else {
Â  Â  Â  Â  setHistory([]);
Â  Â  Â  }
Â  Â  } catch (err) {
Â  Â  Â  console.error("âŒ Error fetching fitness history:", err);
Â  Â  }
Â  };

Â  useEffect(() => {
Â  Â  fetchHistory();
Â  }, [userId]);

Â  const calculateBMI = async () => {
Â  Â  if (!height || !weight) return alert("Please enter current height and weight.");
Â  Â  if (targetWeight && parseFloat(targetWeight) <= 0) return alert("Target weight must be a positive number.");

Â  Â  const heightInMeters = height / 100;
Â  Â  const bmiValue = (weight / (heightInMeters * heightInMeters)).toFixed(1);

Â  Â  let category = "";
Â  Â  
Â  Â  // Set BMI Category
Â  Â  if (bmiValue < 18.5) category = "Underweight";
Â  Â  else if (bmiValue >= 18.5 && bmiValue <= 24.9) category = "Normal";
Â  Â  else if (bmiValue >= 25 && bmiValue <= 29.9) category = "Overweight";
Â  Â  else category = "Obese";
Â  Â  
Â  Â  
Â  Â  try {
Â  Â  Â  // 1. Call Backend API to generate the AI-based plan
Â  Â  Â  const planRes = await API.post("/fitness/generate", { 
          userId, 
          height, 
          weight, 
          weeklyGoal, 
          targetWeight,
          preferredExercises // ğŸ’¡ SEND NEW PREFERENCE
      });

Â  Â  Â  // 2. Extract structured data from the response
Â  Â  Â  const { 
          bmi: finalBmi, 
          category: finalCategory, 
          calories, 
          plan: structuredPlan, // This is the full {warmup, main_workout, cooldown} object
          tip 
      } = planRes.data;

      // The structured plan includes all details:
Â  Â  Â  const bmiData = { 
          value: finalBmi, 
          category: finalCategory, 
          calories, 
          targetWeight: targetWeight || null, 
          weeklyGoal, 
          finalRecommendation: `Based on your goal of **${weeklyGoal}** and preference, here is your AI-generated daily plan.` 
      };
      
Â  Â  Â  setBmi(bmiData);
Â  Â  Â  setPlan(structuredPlan); // Set the entire structured plan object
Â  Â  Â  setTip(tip);

Â  Â  Â  // Re-fetch history to include the new entry
Â  Â  Â  if (userId) {
Â  Â  Â  Â  fetchHistory();
Â  Â  Â  } else {
Â  Â  Â  Â  console.warn("âš ï¸ No userId found, not saving to backend");
Â  Â  Â  }
Â  Â  } catch (err) {
Â  Â  Â  console.error("âŒ Error generating fitness data:", err);
      alert(`Error generating plan: ${err.response?.data?.message || err.message}`);
Â  Â  }
Â  };

Â  const resetPlanner = () => {
Â  Â  setHeight("");
Â  Â  setWeight("");
Â  Â  setTargetWeight("");
Â  Â  setWeeklyGoal(weeklyGoals[0]);
Â  Â  setPreferredExercises(""); // Reset new state
Â  Â  setBmi(null);
Â  Â  setPlan(null);
Â  Â  setTip("");
Â  };

Â  return (
Â  Â  <div className="min-h-screen flex flex-col items-center justify-center bg-white text-gray-800 px-6 py-12">
Â  Â  Â  <motion.div
Â  Â  Â  Â  initial={{ opacity: 0, y: 20 }}
Â  Â  Â  Â  animate={{ opacity: 1, y: 0 }}
Â  Â  Â  Â  transition={{ duration: 0.6 }}
Â  Â  Â  Â  className="bg-white rounded-2xl shadow-2xl border border-teal-100 p-8 w-full max-w-lg"
Â  Â  Â  >
Â  Â  Â  Â  <h1 className="text-3xl md:text-4xl font-extrabold text-center text-teal-600 mb-6">
Â  Â  Â  Â  Â  ğŸ‹ï¸ AI Fitness Planner
Â  Â  Â  Â  </h1>
Â  Â  Â  Â  <div className="space-y-4 mb-6">
Â  Â  Â  Â  Â  {/* Input 1: Height */}
Â  Â  Â  Â  Â  <input
Â  Â  Â  Â  Â  Â  type="number"
Â  Â  Â  Â  Â  Â  placeholder="Enter current height (cm)"
Â  Â  Â  Â  Â  Â  value={height}
Â  Â  Â  Â  Â  Â  onChange={(e) => setHeight(e.target.value)}
Â  Â  Â  Â  Â  Â  className="w-full px-4 py-3 rounded-xl bg-gray-50 border border-gray-300 focus:ring-2 focus:ring-teal-500 focus:outline-none text-gray-800"
Â  Â  Â  Â  Â  />
Â  Â  Â  Â  Â  {/* Input 2: Current Weight */}
Â  Â  Â  Â  Â  <input
Â  Â  Â  Â  Â  Â  type="number"
Â  Â  Â  Â  Â  Â  placeholder="Enter current weight (kg)"
Â  Â  Â  Â  Â  Â  value={weight}
Â  Â  Â  Â  Â  Â  onChange={(e) => setWeight(e.target.value)}
Â  Â  Â  Â  Â  Â  className="w-full px-4 py-3 rounded-xl bg-gray-50 border border-gray-300 focus:ring-2 focus:ring-teal-500 focus:outline-none text-gray-800"
Â  Â  Â  Â  Â  />
Â  Â  Â  Â  Â  {/* Input 3: Target Weight */}
Â  Â  Â  Â  Â  <input
Â  Â  Â  Â  Â  Â  type="number"
Â  Â  Â  Â  Â  Â  placeholder="Enter target weight (kg, optional)"
Â  Â  Â  Â  Â  Â  value={targetWeight}
Â  Â  Â  Â  Â  Â  onChange={(e) => setTargetWeight(e.target.value)}
Â  Â  Â  Â  Â  Â  className="w-full px-4 py-3 rounded-xl bg-gray-50 border border-gray-300 focus:ring-2 focus:ring-teal-500 focus:outline-none text-gray-800"
Â  Â  Â  Â  Â  />
Â  Â  Â  Â  Â  {/* Input 4: Weekly Goal (DROPDOWN) */}
Â  Â  Â  Â  Â  <select
Â  Â  Â  Â  Â  Â  value={weeklyGoal}
Â  Â  Â  Â  Â  Â  onChange={(e) => setWeeklyGoal(e.target.value)}
Â  Â  Â  Â  Â  Â  className="w-full px-4 py-3 rounded-xl bg-gray-50 border border-gray-300 focus:ring-2 focus:ring-teal-500 focus:outline-none text-gray-800 appearance-none"
Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  {weeklyGoals.map((goal) => (
Â  Â  Â  Â  Â  Â  Â  <option key={goal} value={goal}>
Â  Â  Â  Â  Â  Â  Â  Â  Weekly Goal: {goal}
Â  Â  Â  Â  Â  Â  Â  </option>
Â  Â  Â  Â  Â  Â  ))}
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  {/* Input 5: Preferred Exercises (NEW INPUT) */}
Â  Â  Â  Â  Â  <input
Â  Â  Â  Â  Â  Â  type="text"
Â  Â  Â  Â  Â  Â  placeholder="Preferred exercises (e.g., cycling, yoga, weights)"
Â  Â  Â  Â  Â  Â  value={preferredExercises}
Â  Â  Â  Â  Â  Â  onChange={(e) => setPreferredExercises(e.target.value)}
Â  Â  Â  Â  Â  Â  className="w-full px-4 py-3 rounded-xl bg-gray-50 border border-gray-300 focus:ring-2 focus:ring-teal-500 focus:outline-none text-gray-800"
Â  Â  Â  Â  Â  />


Â  Â  Â  Â  Â  <div className="flex space-x-3 pt-2">
Â  Â  Â  Â  Â  Â  <motion.button
Â  Â  Â  Â  Â  Â  Â  whileHover={{ scale: 1.05 }}
Â  Â  Â  Â  Â  Â  Â  whileTap={{ scale: 0.95 }}
Â  Â  Â  Â  Â  Â  Â  onClick={calculateBMI}
Â  Â  Â  Â  Â  Â  Â  className="flex-1 py-3 rounded-xl font-semibold text-lg bg-teal-600 text-white shadow-md hover:bg-teal-700 transition"
Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Generate Plan
Â  Â  Â  Â  Â  Â  </motion.button>
Â  Â  Â  Â  Â  Â  <motion.button
Â  Â  Â  Â  Â  Â  Â  whileHover={{ scale: 1.05 }}
Â  Â  Â  Â  Â  Â  Â  whileTap={{ scale: 0.95 }}
Â  Â  Â  Â  Â  Â  Â  onClick={resetPlanner}
Â  Â  Â  Â  Â  Â  Â  className="p-3 rounded-xl bg-gray-200 hover:bg-gray-300 text-teal-600 shadow-md"
Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  <FaRedo />
Â  Â  Â  Â  Â  Â  </motion.button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <FitnessResults bmi={bmi} plan={plan} tip={tip} />
Â  Â  Â  Â  <FitnessHistory history={history} fetchHistory={fetchHistory} />
Â  Â  Â  </motion.div>
Â  Â  </div>
Â  );
};

export default FitnessPlanner;